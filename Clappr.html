<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auto-Proxy HLS Player</title>

  <style>
    :root { background: #000; color: #fff; }
    html,body { height:100%; margin:0; }
    #wrap { display:flex; flex-direction:column; height:100vh; }
    #player { flex:1; display:flex; align-items:center; justify-content:center; background:#000; }
    video { width:100%; height:100%; object-fit:contain; background:#000; }
    #info { padding:8px 12px; font-size:13px; background:#121212; color:#ddd; display:flex; gap:12px; align-items:center; }
    #error { color: #ff6b6b; }
    .small { font-size:12px; color:#aaa; }
    button { background:#233; color:#dff; border:1px solid #2b6; padding:6px 10px; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="player">
      <video id="video" controls playsinline></video>
    </div>

    <div id="info">
      <div id="status">⏳ Ініціалізація...</div>
      <div class="small" id="srcDisplay"></div>
      <div style="margin-left:auto">
        <button id="reloadBtn">Перезавантажити</button>
      </div>
    </div>
  </div>

  <!-- HLS.js 1.x -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@~1/dist/hls.min.js"></script>

  <script>
    (function(){
      const params = new URLSearchParams(window.location.search);
      const original = params.get("url");
      const video = document.getElementById("video");
      const status = document.getElementById("status");
      const srcDisplay = document.getElementById("srcDisplay");
      const reloadBtn = document.getElementById("reloadBtn");

      function showStatus(text){
        status.textContent = text;
      }

      if (!original) {
        document.getElementById("player").innerHTML = "<div style='color:white;padding:20px;text-align:center'>❗ Не передано параметр <b>url</b></div>";
        showStatus("Немає url");
        throw new Error("url not provided");
      }

      // Побудова проксованого URL (той самий формат, який ти використовуєш)
      const proxied = "https://v5on.site/proxy4.php?url=" + encodeURIComponent(original)
                    + "&header_Referer=" + encodeURIComponent("https://myfootball.life/");

      srcDisplay.textContent = proxied;

      // Можливість перезавантажити вручну
      reloadBtn.addEventListener("click", () => {
        showStatus("Перезавантаження потоку...");
        attachStream();
      });

      // Основна функція: підключаємо Hls.js якщо можливо, інакше fallback на native src
      function attachStream(){
        // скидаємо попередній src / hls
        if (window._hlsInstance) {
          try { window._hlsInstance.destroy(); } catch(e) { /* ignore */ }
          window._hlsInstance = null;
        }
        video.pause();
        video.removeAttribute("src");
        video.load();

        showStatus("Підготовка відтворення...");

        // Якщо Hls.js підтримується → використовуємо його (більше контролю)
        if (window.Hls && Hls.isSupported()) {
          const hls = new Hls({
            // налаштування буфера — можна підкоригувати за потреби
            maxBufferLength: 30,
            maxMaxBufferLength: 120,
            liveSyncDuration: 10,
          });
          window._hlsInstance = hls;

          hls.on(Hls.Events.MANIFEST_PARSED, function() {
            showStatus("Manifest завантажено — відтворення...");
            // деякі браузери не дозволяють autoplay зі звуком
            // video.muted = true; // якщо потрібно авто-старт на мобайлі — розкоментуй
            video.play().catch(()=>{/* autoplay blocked */});
          });

          hls.on(Hls.Events.ERROR, function(event, data) {
            console.error("HLS error", event, data);
            if (data && data.fatal) {
              showStatus("HLS помилка (fatal) — спробую перезавантажити...");
              // простий recovery-паттерн
              switch (data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  showStatus("Network error — перезапуск завантаження...");
                  hls.startLoad();
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  showStatus("Media error — відновлюю...");
                  hls.recoverMediaError();
                  break;
                default:
                  showStatus("Фатальна помилка — пробую destroy і fallback...");
                  hls.destroy();
                  fallbackNative();
              }
            }
          });

          hls.on(Hls.Events.LEVEL_SWITCHED, (evt, data) => {
            // можна показувати поточну якість, якщо треба
            // console.log('level switched', data);
          });

          hls.loadSource(proxied);
          hls.attachMedia(video);
        } else {
          // Fallback: використовуємо native video src (наприклад на iPhone)
          fallbackNative();
        }
      }

      function fallbackNative(){
        showStatus("Використовую нативний плеєр (fallback)...");
        video.src = proxied;
        video.addEventListener('loadedmetadata', () => {
          showStatus("Нативний плеєр готовий — відтворення...");
          video.play().catch(()=>{/* autoplay blocked */});
        });
        video.addEventListener('error', (e) => {
          console.error('Video element error', e);
          showStatus("Помилка відтворення. Перевір проксі, CORS і доступність потоку.");
          const errEl = document.createElement('div');
          errEl.id = 'error';
          errEl.textContent = "❌ Не вдалось відтворити поток. Можливі причини: проксі недоступний, CORS або некоректний URL.";
          document.getElementById('player').appendChild(errEl);
        }, { once: true });
      }

      // Запускаємо
      attachStream();

      // Додатково — зручно: клавіша R = перезавантажити
      window.addEventListener('keydown', (e) => {
        if (e.key === 'r' || e.key === 'R') attachStream();
      });

      // Лог в консолі для діагностики
      console.log("Original URL:", original);
      console.log("Proxied URL:", proxied);
    })();
  </script>
</body>
</html>
